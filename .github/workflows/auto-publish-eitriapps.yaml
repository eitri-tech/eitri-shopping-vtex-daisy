name: Push and publish Eitri Application

on:
  pull_request:
    types:
      - closed
    branches:
      - develop
      - main

env:
  EITRI_CLI_CLIENT_ID: ${{ secrets.EITRI_CLI_CLIENT_ID }}
  EITRI_CLI_CLIENT_SECRET: ${{ secrets.EITRI_CLI_CLIENT_SECRET }}

  DEV_ENVID: ${{ vars.APP_DEV_ENV_ID }}
  PROD_ENVID: ${{ vars.APP_PRD_ENV_ID }}

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Check if PR was merged
        run: |
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "âŒ PR foi fechado sem merge. Encerrando pipeline."
            exit 0
          fi
          echo "â˜‘ï¸ PR foi mergeado. Continuando pipeline..."

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Eitri CLI
        run: npm install -g eitri-cli

      - name: Detect changed Eitri-apps by version
        id: detect
        run: |
          set -euo pipefail
          trap 'echo "âŒ Falha na detecÃ§Ã£o de eitri-apps alterados!"' ERR

          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          echo "ðŸ”— Base SHA: $BASE_SHA"
          echo "ðŸ”— Head SHA: $HEAD_SHA"

          SHARED_MODULES=""
          NON_SHARED_MODULES=""

          for config_file in $(find . -name 'eitri-app.conf.js'); do
            module_dir=$(dirname "$config_file")
            echo "ðŸ”ðŸ”ðŸ” Analisando mÃ³dulo: $module_dir"

            NEW_VERSION=$(git show $HEAD_SHA:"$config_file" | grep "version" | head -1 | sed -E 's/.*version[^:]*:\s*["'\'']([^"'\'']+)["'\''].*/\1/' || echo "undefined")
            OLD_VERSION=$(git show $BASE_SHA:"$config_file" | grep "version" | head -1 | sed -E 's/.*version[^:]*:\s*["'\'']([^"'\'']+)["'\''].*/\1/' || echo "undefined")

            if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
              echo "ðŸ”¸ VersÃ£o modificada: $OLD_VERSION -> $NEW_VERSION"

              SHARED_VERSION=$(git show $HEAD_SHA:"$config_file" | grep "sharedVersion" | head -1 | sed -E 's/.*sharedVersion[^:]*:\s*["'\'']([^"'\'']+)["'\''].*/\1/' || echo "")

              if [ "$SHARED_VERSION" = "v2" ]; then
                SHARED_MODULES="$SHARED_MODULES $module_dir"
                echo "ðŸ”¸ Eitri-app shared identificado."
              else
                NON_SHARED_MODULES="$NON_SHARED_MODULES $module_dir"
              fi
            else
              echo "â­ï¸ VersÃ£o nÃ£o modificada, ignorando."
            fi
          done

          echo "shared_modules=$SHARED_MODULES" >> $GITHUB_OUTPUT
          echo "non_shared_modules=$NON_SHARED_MODULES" >> $GITHUB_OUTPUT

          echo "âœ…âœ…âœ… Eitri-apps shared a publicar: $SHARED_MODULES"
          echo "âœ…âœ…âœ… Demais eitri-apps a publicar: $NON_SHARED_MODULES"

      - name: Publish shared Eitri-apps
        if: steps.detect.outputs.shared_modules != ''
        run: |
          set -euo pipefail
          trap 'echo "âŒ Falha ao publicar eitri-apps shared!"' ERR

          PUBLISHED_MODULES=""

          for module in ${{ steps.detect.outputs.shared_modules }}; do
            echo "âš™ï¸âš™ï¸âš™ï¸ Publicando shared eitri-app: $module"

            pushd "$module" > /dev/null

            if [[ "${{ github.base_ref }}" == "main" ]]; then
              ENV_ID="${{ env.PROD_ENVID }}"
            else
              ENV_ID="${{ env.DEV_ENVID }}"
            fi

            echo "ðŸ”¸ Executando 'eitri push-version --shared --message \"${{ github.event.pull_request.title }}\"'"
            eitri push-version --shared --message "${{ github.event.pull_request.title }}"

            if [[ "${{ github.base_ref }}" == "develop" ]]; then
              echo "ðŸ”¸ Executando 'eitri publish -e $ENV_ID' em DEV"
              eitri publish -e $ENV_ID
            else
              echo "âš ï¸ PublicaÃ§Ã£o desativada, PR nÃ£o Ã© para develop."
            fi

            popd > /dev/null
            PUBLISHED_MODULES="$PUBLISHED_MODULES $module"
            echo "âœ… Finalizado: $module"
          done

          echo "âœ…âœ…âœ… Eitri-apps shared publicados: $PUBLISHED_MODULES"

      - name: Publish non-shared Eitri-apps
        if: steps.detect.outputs.non_shared_modules != ''
        run: |
          set -euo pipefail
          trap 'echo "âŒ Falha ao publicar mÃ³dulos nÃ£o compartilhados!"' ERR

          PUBLISHED_MODULES=""

          for module in ${{ steps.detect.outputs.non_shared_modules }}; do
            echo "âš™ï¸ Publicando mÃ³dulo nÃ£o compartilhado: $module"

            pushd "$module" > /dev/null

            if [[ "${{ github.base_ref }}" == "main" ]]; then
              ENV_ID="${{ env.PROD_ENVID }}"
            else
              ENV_ID="${{ env.DEV_ENVID }}"
            fi

            echo "ðŸŒ Ambiente selecionado: $ENV_ID"

            echo "ðŸ”— Executando 'eitri push-version --message \"PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\"'"
            eitri push-version --message "${{ github.event.pull_request.title }}"

            if [[ "${{ github.base_ref }}" == "develop" ]]; then
              echo "ðŸš€ Publicando com 'eitri publish -e $ENV_ID'"
              eitri publish -e $ENV_ID
            else
              echo "â­ï¸ PublicaÃ§Ã£o desativada, PR nÃ£o Ã© para develop."
            fi

            popd > /dev/null
            PUBLISHED_MODULES="$PUBLISHED_MODULES $module"
            echo "âœ…âœ…âœ… Finalizado: $module"
          done

          echo "âœ…âœ…âœ… Eitri-apps publicados: $PUBLISHED_MODULES"
